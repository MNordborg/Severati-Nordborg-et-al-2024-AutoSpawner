---
title: "2022_AutoSpawn_AllSpp_Culture survival"
output: html_document
date: "2023-03-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#For data import and wrangling
library(readr)
library(dplyr)

#For model fitting, comparisons & extraction of results
library(rstan)
library(brms) 
require(tidyverse)

#For data visualisation
library(ggplot2)
library(scales)
library(ggpubr)
```


## Background
Analysis of data sets from experiments comparing the survival in standard culture tanks of coral larvae produced using the novel AutoSpawner systems to those produced using traditional, manual fertilisation techniques. The data analysis was primarily performed in two steps:
    - Bayesian linear regression models fitted for each data set
    - Comparison of posterior distributions of model medians and 95% credible intervals for the AutoSpawner and Traditional fertilisation methods

Compromised or invalid replicates were identified prior to data import into R, but removal of replicates was performed after import. Please see methods of main paper and the corresponding data sheet for further details. 

The main data sets consist of binomial and count data and the following terms are used throughout:
    year = year and month experiment was performed
    species = species assessed
    origin = where parent colonies originated from
    endpoint = endpoint assessed
    factor = fertilisation method used
        AS = AutoSpawner/dynamic fertilisation
        M = Manual/traditional/static fertilisation
    tank = larval culture tank ID
    tank_rep = culture tank technical replicate ID (1 or 2)
    assess_date = date assessed
    larval_age = days post-fertilisation when assessment was performed
    rep = replicate sample
    vol_sampl = total volume sampled from culture tank (mL)
    vol_conc = volume the sample was concentrated to (mL)
    vol_subsampl = volume subsampled for each replicate count from the concentrated culture sample (mL)
    L_counted = total number of organisms in replicate at time of assessment
    L_total_sampl = calculated total number of larvae in sample collected from culture tank (based on individual replicate counts of submsamples)
    density = larval density in sample collected from culture tank (larvae/mL)
    L_tank_total = calculated total number of larvae in culture tank
    comments = other observations or comments for sample
    use_in_model = whether sample should be included in statistical analysis (yes or no)
    reason_for_exclusion = why a sample was excluded from statistical analysis



Analysis performed by Dr Mikaela Nordborg.


## Packages used and installation of latest version of bayesnec

Analysis performed using package brms and it's dependencies in R Version 4.2.2 through RStudio version 2023.03.0-386. The latest version of brms and rstan, including all dependencies, were installed prior to start of analysis (5 March 2023).


## Analysis

### Import data, perform data preparation and check data types

Import data, wrangle and do quick initial checks
```{r}
data_All_2022_surv_raw<- read_csv("2022_AS_AllSpp_surv_data.csv") %>% 
  data.frame() %>% 
  dplyr::mutate(species=as.factor(as.character(species)),
                factor=as.factor(as.character(factor)),
                tank=as.factor(as.character(tank)),
                tank_rep=as.factor(as.character(tank_rep)),
                rep = as.integer(as.character(rep)),
                larval_age = as.integer(as.character(larval_age)),
                density = as.numeric(as.character(density)),
                L_tank_total =as.integer(as.character(L_tank_total)),
                tank_unique=as.factor(group_indices(., species, factor, tank_rep)), #add unique identifiers for each technical replicate to allow for use as a random effect
                rep_unique=as.factor(row_number())) #add unique identifiers for each count replicate to allow for use as a random effect


save(data_All_2022_surv_raw, file = "2022_AutoSpawn_AllSpp_data_surv.RData")

#Check that all columns have been assigned the correct data type & that adding 0.1 to raw.x controls worked
str(data_All_2022_surv_raw)
head(data_All_2022_surv_raw)
tail(data_All_2022_surv_raw)

#Remove any replicates that should be excluded from analysis
data_All_2022_surv <- data_All_2022_surv_raw %>% 
  dplyr::filter(use_in_model=="Yes")

#Check that removing replicates to be excluded from analysis worked
View(data_All_2022_surv)

save(data_All_2022_surv_raw, data_All_2022_surv, file = "2022_AutoSpawn_AllSpp_data_surv.RData")
```


Data exploration
```{r}
load("2022_AutoSpawn_AllSpp_data_surv.RData")


#Plot to explore the data distribution
ggplot(data_All_2022_surv, aes(x=larval_age, y=L_tank_total, colour=factor, shape=species)) +
  geom_point() +
  facet_grid(factor(species, levels=c('Atenuis', 'Melephantotus', 'Aloripes', 'Dfavus')) ~ ., scales = "free_y", space = "free_y")
```

### Fit candidate models
#### Full model
Model fitting and model fit evaluation
```{r}
#Fit linear regression models
All_surv_brms_fit_int <- brm(L_tank_total ~ factor + species + larval_age + (1 | tank_unique) + (1 | rep_unique), data = data_All_2022_surv, family = poisson(), chains = 4, iter = 10000)
All_surv_brms_fit_int <- add_criterion(All_surv_brms_fit_int, c("loo", "waic"))
```

Check model summary
```{r}
summary(All_surv_brms_fit_int)
```
    - Does the 95% CIs of any factor exclude 0? (ie the factor had a significant effect on y)
        -> Yes (Atenuis compared to Aloripes; Melephantotus comapred to Aloripes; larval_age)
    
    - Are any Rhat values substantially higher than 1.1? (ie chains did not converge and model needs to be re-run with more iterations)
        -> Yes, and increasing iterations from 2,000 to 10,000 did not resolve the issue.
    
    - Are any Rhat values substantially lower than 0.9? (ie the model is underdispersed)
        -> No


Check model chain mixing and posterior distribution for factors
```{r}
plot(All_surv_brms_fit_int, ask=FALSE)
```

*Any evidence of non-convergence, poor chain mixing or overly influential priors?*
    - Yes
    

Compare the observed posterior to expected values:
```{r}
pp_check(All_surv_brms_fit_int)  # shows dens_overlay plot by default
pp_check(All_surv_brms_fit_int, type = "scatter_avg", ndraws = 100)
pp_check(All_surv_brms_fit_int, type = "rootogram")
```

```{r}
conditional_effects(All_surv_brms_fit_int, ask=FALSE)
```


#### Models for individual species

Filter dataframe per species
```{r}
data_AT_2022_surv <- data_All_2022_surv  %>% 
  dplyr::filter(species=="Atenuis")
data_DF_2022_surv <- data_All_2022_surv  %>% 
  dplyr::filter(species=="Dfavus")
data_AL_2022_surv <- data_All_2022_surv  %>% 
  dplyr::filter(species=="Aloripes")
data_ME_2022_surv <- data_All_2022_surv  %>% 
  dplyr::filter(species=="Melephantotus")

save(data_All_2022_surv_raw, data_All_2022_surv, data_AT_2022_surv, data_DF_2022_surv, data_AL_2022_surv, data_ME_2022_surv, file = "2022_AutoSpawn_AllSpp_data_surv.RData")
```

##### Acropora tenuis
Model fitting and model fit evaluation
```{r}
#Fit linear regression models
All_surv_brms_fit_AT <- brm(L_tank_total ~ factor * larval_age + (1 | tank_unique) + (1 | rep_unique), data = data_AT_2022_surv, family = poisson(), chains = 4, iter = 8000)
All_surv_brms_fit_AT <- add_criterion(All_surv_brms_fit_AT, c("loo", "waic"))
```

Check model summary
```{r}
summary(All_surv_brms_fit_AT)
```
    - Does the 95% CIs of any factor exclude 0? (ie the factor had a significant effect on y)
        -> No
    
    - Are any Rhat values substantially higher than 1.1? (ie chains did not converge and model needs to be re-run with more iterations)
        -> No
        
    - Are any Rhat values substantially lower than 0.9? (ie the model is underdispersed)
        -> No


Check model chain mixing and posterior distribution for factors
```{r}
pdf("2022_AutoSpawn_AllSpp_surv_AT_checkchains.pdf")
plot(All_surv_brms_fit_AT, ask=FALSE)
dev.off()
```

*Any evidence of non-convergence, poor chain mixing or overly influential priors?*
    - No
    

Compare the observed posterior to expected values:
```{r}
pp_check(All_surv_brms_fit_AT)  # shows dens_overlay plot by default
pp_check(All_surv_brms_fit_AT, type = "scatter_avg", ndraws = 100)
pp_check(All_surv_brms_fit_AT, type = "rootogram")
```

```{r}
conditional_effects(All_surv_brms_fit_AT)
```

    Does the credible intervals for one fertilisation method not overlap the emdian for the other fertilisation method at any time point?
        - No (ie there is no statistical difference at any time point during larval rearing)

##### Dipsastrea favus
Model fitting and model fit evaluation
```{r}
#Fit linear regression models
All_surv_brms_fit_DF <- brm(L_tank_total ~ factor * larval_age + (1 | tank_unique) + (1 | rep_unique), data = data_DF_2022_surv, family = poisson(), chains = 4, iter = 8000)
All_surv_brms_fit_DF <- add_criterion(All_surv_brms_fit_DF, c("loo", "waic"))
```

Check model summary
```{r}
summary(All_surv_brms_fit_DF)
```
    - Does the 95% CIs of any factor exclude 0? (ie the factor had a significant effect on y)
        -> No
    
    - Are any Rhat values substantially higher than 1.1? (ie chains did not converge and model needs to be re-run with more iterations)
        -> No
    
    - Are any Rhat values substantially lower than 0.9? (ie the model is underdispersed)
        -> No


Check model chain mixing and posterior distribution for factors
```{r}
pdf("2022_AutoSpawn_AllSpp_surv_DF_checkchains.pdf")
plot(All_surv_brms_fit_DF, ask=FALSE)
dev.off()
```

*Any evidence of non-convergence, poor chain mixing or overly influential priors?*
    - Possibly for larval_Age and factorM:larval_age
    

Compare the observed posterior to expected values:
```{r}
pp_check(All_surv_brms_fit_DF)  # shows dens_overlay plot by default
pp_check(All_surv_brms_fit_DF, type = "scatter_avg", ndraws = 100)
pp_check(All_surv_brms_fit_DF, type = "rootogram")
```

```{r}
conditional_effects(All_surv_brms_fit_DF, ask=FALSE)
```

    Does the credible intervals for one fertilisation method not overlap the emdian for the other fertilisation method at any time point?
        - No (ie there is no statistical difference at any time point during larval rearing)

##### Acropora loripes
Model fitting and model fit evaluation
```{r}
#Fit linear regression models
All_surv_brms_fit_AL <- brm(L_tank_total ~ factor * larval_age + (1 | tank_unique) + (1 | rep_unique), data = data_AL_2022_surv, family = poisson(), chains = 4, iter = 8000)
All_surv_brms_fit_AL <- add_criterion(All_surv_brms_fit_AL, c("loo", "waic"))
```

Check model summary
```{r}
summary(All_surv_brms_fit_AL)
```
    - Does the 95% CIs of any factor exclude 0? (ie the factor had a significant effect on y)
        -> Yes (larval_age)
    
    - Are any Rhat values substantially higher than 1.1? (ie chains did not converge and model needs to be re-run with more iterations)
        -> No
    
    - Are any Rhat values substantially lower than 0.9? (ie the model is underdispersed)
        -> No


Check model chain mixing and posterior distribution for factors
```{r}
pdf("2022_AutoSpawn_AllSpp_surv_AL_checkchains.pdf")
plot(All_surv_brms_fit_AL, ask=FALSE)
dev.off()
```

*Any evidence of non-convergence, poor chain mixing or overly influential priors?*
    - Possibly for larval_age and factorM:larval_age
    

Compare the observed posterior to expected values:
```{r}
pp_check(All_surv_brms_fit_AL)  # shows dens_overlay plot by default
pp_check(All_surv_brms_fit_AL, type = "scatter_avg", ndraws = 100)
pp_check(All_surv_brms_fit_AL, type = "rootogram")
```

```{r}
conditional_effects(All_surv_brms_fit_AL, ask=FALSE)
```

    Does the credible intervals for one fertilisation method not overlap the emdian for the other fertilisation method at any time point?
        - No (ie there is no statistical difference at any time point during larval rearing)

##### Mycedium elephantotus
Model fitting and model fit evaluation
```{r}
#Fit linear regression models
All_surv_brms_fit_ME <- brm(L_tank_total ~ factor * larval_age + (1 | tank_unique) + (1 | rep_unique), data = data_ME_2022_surv, family = poisson(), chains = 4, iter = 10000)
All_surv_brms_fit_ME <- add_criterion(All_surv_brms_fit_ME, c("loo", "waic"))
```

Check model summary
```{r}
summary(All_surv_brms_fit_ME)
```
    - Does the 95% CIs of any factor exclude 0? (ie the factor had a significant effect on y)
        -> Yes, barely (FactorM:larval_age)
    
    - Are any Rhat values substantially higher than 1.1? (ie chains did not converge and model needs to be re-run with more iterations)
        -> Not substantially, but slightly (factorM:larval_age)
    
    - Are any Rhat values substantially lower than 0.9? (ie the model is underdispersed)
        -> No


Check model chain mixing and posterior distribution for factors
```{r}
pdf("2022_AutoSpawn_AllSpp_surv_ME_checkchains.pdf")
plot(All_surv_brms_fit_ME, ask=FALSE)
dev.off()
```

*Any evidence of non-convergence, poor chain mixing or overly influential priors?*
    - Yes, for larval_age and factorM:larval_Age
    

Compare the observed posterior to expected values:
```{r}
pp_check(All_surv_brms_fit_ME)  # shows dens_overlay plot by default
#pp_check(All_surv_brms_fit_ME, type = "scatter_avg", ndraws = 100)
pp_check(All_surv_brms_fit_ME, type = "rootogram")
```

```{r}
conditional_effects(All_surv_brms_fit_ME, ask=FALSE)
```

    Does the credible intervals for one fertilisation method not overlap the emdian for the other fertilisation method at any time point?
        - No (ie there is no statistical difference at any time point during larval rearing)

#### Save fitted models as RData objects
```{r}
save(All_surv_brms_fit_AT, All_surv_brms_fit_DF, All_surv_brms_fit_AL, All_surv_brms_fit_ME, file = "2022_AutoSpawn_AllSpp_surv_modfits.RData")
```





### Extract posterior predictions and test for differences between treatment groups/model coefficients
```{r}
load("2022_AutoSpawn_AllSpp_surv_modfits.RData")

All_surv_post_preds_AT <- conditional_effects(All_surv_brms_fit_AT)
All_surv_post_preds_DF <- conditional_effects(All_surv_brms_fit_DF)
All_surv_post_preds_AL <- conditional_effects(All_surv_brms_fit_AL)
All_surv_post_preds_ME <- conditional_effects(All_surv_brms_fit_ME)

save(All_surv_post_preds_AT, All_surv_post_preds_DF, All_surv_post_preds_AL, All_surv_post_preds_ME, file = "2022_AutoSpawn_AllSpp_surv_PosteriorPredictions.RData")

#check that it worked
head(c)
```



Pull out the relevant dataframe and an additional column to the posterior prediction for each species
```{r}
All_surv_post_preds_AT_OverTime <- All_surv_post_preds_AT$`larval_age:factor`
All_surv_post_preds_AT_OverTime$species <- as.factor("Atenuis")
All_surv_post_preds_AT_OverTime$name <- paste(All_surv_post_preds_AT_OverTime$species, All_surv_post_preds_AT_OverTime$factor)
head(All_surv_post_preds_AT_OverTime)

All_surv_post_preds_DF_OverTime <- All_surv_post_preds_DF$`larval_age:factor`
All_surv_post_preds_DF_OverTime$species <- as.factor("Dfavus")
All_surv_post_preds_DF_OverTime$name <- paste(All_surv_post_preds_DF_OverTime$species, All_surv_post_preds_DF_OverTime$factor)
head(All_surv_post_preds_DF_OverTime)

All_surv_post_preds_AL_OverTime <- All_surv_post_preds_AL$`larval_age:factor`
All_surv_post_preds_AL_OverTime$species <- as.factor("Aloripes")
All_surv_post_preds_AL_OverTime$name <- paste(All_surv_post_preds_AL_OverTime$species, All_surv_post_preds_AL_OverTime$factor)
head(All_surv_post_preds_AL_OverTime)

All_surv_post_preds_ME_OverTime <- All_surv_post_preds_ME$`larval_age:factor`
All_surv_post_preds_ME_OverTime$species <- as.factor("Melephantotus")
All_surv_post_preds_ME_OverTime$name <- paste(All_surv_post_preds_ME_OverTime$species, All_surv_post_preds_ME_OverTime$factor)
head(All_surv_post_preds_ME_OverTime)

save(All_surv_post_preds_AT, All_surv_post_preds_DF, All_surv_post_preds_AL, All_surv_post_preds_ME, All_surv_post_preds_AT_OverTime, All_surv_post_preds_DF_OverTime, All_surv_post_preds_AL_OverTime, All_surv_post_preds_ME_OverTime, file = "2022_AutoSpawn_AllSpp_surv_PosteriorPredictions.RData")
```



### Plot results
#### Wrangle raw data points
Filter raw data to enable plotting of original data points
```{r}
AS_AT_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="AS" & species=="Atenuis")
AS_AT_surv$name <- "Atenuis AS"
M_AT_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="M" & species=="Atenuis")
M_AT_surv$name <- "Atenuis M"

AS_DF_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="AS" & species=="Dfavus")
AS_DF_surv$name <- "Dfavus AS"
M_DF_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="M" & species=="Dfavus")
M_DF_surv$name <- "Dfavus M"

AS_AL_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="AS" & species=="Aloripes")
AS_AL_surv$name <- "Aloripes AS"
M_AL_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="M" & species=="Aloripes")
M_AL_surv$name <- "Aloripes M"

AS_ME_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="AS" & species=="Melephantotus")
AS_ME_surv$name <- "Melephantotus AS"
M_ME_surv <- data_All_2022_surv %>%
  dplyr::filter(factor=="M" & species=="Melephantotus")
M_ME_surv$name <- "Melephantotus M"

save(data_All_2022_surv_raw, data_All_2022_surv, AS_AT_surv, M_AT_surv, AS_DF_surv, M_DF_surv, AS_AL_surv, M_AL_surv, AS_ME_surv, M_ME_surv, file = "2022_AutoSpawn_AllSpp_data_surv.RData")
```



#### Plot posterior differences
Faceted graphs
```{r}
load( "2022_AutoSpawn_AllSpp_data_surv.RData")
load("2022_AutoSpawn_AllSpp_surv_modfits.RData")
load("2022_AutoSpawn_AllSpp_surv_PosteriorPredictions.RData")

All_surv_posterior_plot_facet <- ggplot() + 
  facet_grid(factor(species, levels=c('Atenuis', 'Melephantotus', 'Aloripes', 'Dfavus')) ~ ., scales = "free_y", space = "free_y") +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5, 6), name ="Time (days)") + #labels = scales::percent,
  scale_y_continuous(limits = c(0, 145000), name ="Total larvae") +
  theme_classic() +
  scale_color_manual(values = c("Atenuis AS" = "steelblue4",
                                "Atenuis M"= "steelblue3",
                                "Dfavus AS" = "gray44",
                                "Dfavus M"= "gray63",
                                "Aloripes AS" = "turquoise4",
                                "Aloripes M"="turquoise3",
                                "Melephantotus AS" = "seagreen4",
                                "Melephantotus M"= "seagreen3")) +
  scale_fill_manual(values = c("Atenuis AS" = "steelblue4",
                                "Atenuis M"= "steelblue2",
                                "Dfavus AS" = "gray44",
                                "Dfavus M"= "gray73",
                                "Aloripes AS" = "turquoise4",
                                "Aloripes M"="turquoise2",
                                "Melephantotus AS" = "seagreen4",
                                "Melephantotus M"= "seagreen2")) + 
  #labs(x=expression(), 
   #            subtitle="Comparison of treatments") +
  theme(legend.position="none") + #"top"
  guides(scale=TRUE, shape=FALSE, alpha = FALSE) +

  
#Add in credible intervals
  geom_ribbon(data=All_surv_post_preds_AT_OverTime, aes(x=larval_age, ymin=lower__, ymax=upper__, fill = name), alpha=0.3) +
   geom_ribbon(data=All_surv_post_preds_DF_OverTime, aes(x=larval_age, ymin=lower__, ymax=upper__, fill = name), alpha=0.3) +
   geom_ribbon(data=All_surv_post_preds_AL_OverTime, aes(x=larval_age, ymin=lower__, ymax=upper__, fill = name), alpha=0.3) +
   geom_ribbon(data=All_surv_post_preds_ME_OverTime, aes(x=larval_age, ymin=lower__, ymax=upper__, fill = name), alpha=0.3) +
  
#Add in model median
  geom_line(data=All_surv_post_preds_AT_OverTime, aes(x=larval_age, y=estimate__, group=name, colour=name)) +
   geom_line(data=All_surv_post_preds_DF_OverTime, aes(x=larval_age, y=estimate__, group=name, colour=name)) +
   geom_line(data=All_surv_post_preds_AL_OverTime, aes(x=larval_age, y=estimate__, group=name, colour=name)) +
   geom_line(data=All_surv_post_preds_ME_OverTime, aes(x=larval_age, y=estimate__, group=name, colour=name)) +
  
  
#Add in raw data points
  geom_point(data = AS_AT_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1)) +
  geom_point(data = M_AT_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1))+
  geom_point(data = AS_DF_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1)) +
  geom_point(data = M_DF_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1))+
  geom_point(data = AS_AL_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1.5)) +
  geom_point(data = M_AL_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1))+
  geom_point(data = AS_ME_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1)) +
  geom_point(data = M_ME_surv, aes(x=larval_age, y=L_tank_total, colour=factor(name), shape=factor(species), alpha=0.3), position=position_jitter(width=0.005, height=1))


All_surv_posterior_plot_facet
```

### Export graphs
```{r}
pdf("AS_surv_plot_Allspp.pdf", width = 7.69, height = 5.46) #height and width in inches
All_surv_posterior_plot_facet
dev.off()
```
